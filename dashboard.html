<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Family Yodeck Dashboard</title>
<style>
  :root{
    --bg:#0f1724;
    --card:#0b1220;
    --accent:#7cc6ff;
    --muted:#98a2b3;
    --good:#7ee787;
    font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#07101a);color:#e6eef7}
  .wrap{display:grid;grid-template-columns:1fr 420px;grid-template-rows:120px 1fr;gap:16px;padding:18px;height:100vh;box-sizing:border-box}
  header{grid-column:1/3;display:flex;align-items:center;justify-content:space-between;padding:12px 18px;background:rgba(255,255,255,0.02);border-radius:10px;backdrop-filter: blur(6px)}
  header .left{display:flex;flex-direction:column}
  header h1{margin:0;font-size:20px}
  header p{margin:2px 0 0;color:var(--muted);font-size:13px}
  .kindness{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:16px;border-radius:10px;overflow:auto}
  .kindness h2{margin:0 0 10px;font-size:16px}
  .leader{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .kid{background:var(--card);padding:10px;border-radius:8px;display:flex;flex-direction:column;gap:8px}
  .kid .row{display:flex;justify-content:space-between;align-items:center}
  .bar{height:10px;background:rgba(255,255,255,0.06);border-radius:999px;overflow:hidden}
  .bar > span{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#6ee7b7);width:0%}
  .rightcol{grid-row:2;display:flex;flex-direction:column;gap:16px}
  .card{background:var(--card);padding:14px;border-radius:10px;min-height:120px}
  .chore-wheel{display:flex;flex-direction:column;align-items:center;gap:12px}
  .wheel{width:260px;height:260px;border-radius:50%;position:relative;overflow:hidden;border:6px solid rgba(255,255,255,0.03)}
  .segment{position:absolute;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;transform-origin:center center}
  .center-dot{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:76px;height:76px;border-radius:50%;background:linear-gradient(180deg,rgba(255,255,255,0.04), rgba(255,255,255,0.02));display:flex;align-items:center;justify-content:center;font-weight:700}
  .events{display:flex;flex-direction:column;gap:10px}
  .event{display:flex;justify-content:space-between;align-items:center;padding:8px;background:rgba(255,255,255,0.02);border-radius:8px}
  .footer-ticker{grid-column:1/3;padding:8px 18px;border-radius:8px;background:rgba(255,255,255,0.01);display:flex;gap:12px;align-items:center;overflow:hidden}
  .ticker-inner{white-space:nowrap;animation:scroll 18s linear infinite}
  @keyframes scroll{0%{transform:translateX(100%)}100%{transform:translateX(-100%)}}
  .weather{display:flex;gap:12px;align-items:center}
  .weather .big{font-size:26px;font-weight:700}
  .muted{color:var(--muted)}
  .spin-btn{background:var(--accent);color:#04263a;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
  .small{font-size:13px}
  /* responsive */
  @media (max-width:980px){.wrap{grid-template-columns:1fr;grid-template-rows:auto auto auto auto} .rightcol{grid-row:auto}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="left">
      <h1>Baer Family Dashboard</h1>
      <p id="todayHuman">Loading date...</p>
    </div>
    <div class="weather" id="weatherBlock">
      <div class="small muted">Weather</div>
      <div class="big" id="temp">--°</div>
      <div id="conditions" class="muted small">—</div>
    </div>
  </header>

  <section class="kindness card" id="kindnessCard">
    <h2>Kindness Marks</h2>
    <div class="leader" id="leaderboard">
      <!-- kids populate here -->
    </div>
  </section>

  <aside class="rightcol">
    <div class="card chore-wheel">
      <h3 style="margin:0">Chore Wheel — This Week</h3>
      <div id="choreMeta" class="muted small">rotation info</div>
      <div class="wheel" id="wheelSvg" aria-hidden="true"></div>
      <div class="center-dot" id="centerLabel">Who?</div>
      <div style="display:flex;gap:8px">
        <button class="spin-btn" id="spinNow">Spin (demo)</button>
        <div class="muted small" style="align-self:center">Auto-rotates each Sunday</div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0">Upcoming Events</h3>
      <div class="events" id="eventsList">
        <!-- events -->
      </div>
    </div>
  </aside>

  <div class="card" style="grid-column:1/2">
    <h3 style="margin:0 0 8px 0">Full Chore Assignments (this week)</h3>
    <div id="assignTable" class="muted small">Loading...</div>
  </div>

  <div class="card" style="grid-column:2/3">
    <h3 style="margin:0 0 8px 0">Notes / Quote</h3>
    <div id="quoteBlock" class="muted small">"Be kind — you never know what someone is going through."</div>
  </div>

  <div class="footer-ticker" style="margin-top:8px">
    <div class="muted small">Events: </div>
    <div class="ticker-inner" id="ticker">Loading upcoming events…</div>
  </div>
</div>

<script>

const CONFIG = {
  SHEET_ID: "1mV94O61-bvxnziv-zIxzjC7to0ccLyFvEBg9xMJ5mO4",
  KINDNESS_SHEET: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_Oy4G9QEpQ51U9d7O6epRRsfj1V7K5rnDRvFDOhaoSrVo_Dv7S2XBMjgRnOdfuDkQ7p0uV9DeQJPF/pub?gid=0&single=true&output=csv",
  CHORES_SHEET: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_Oy4G9QEpQ51U9d7O6epRRsfj1V7K5rnDRvFDOhaoSrVo_Dv7S2XBMjgRnOdfuDkQ7p0uV9DeQJPF/pub?gid=1278067763&single=true&output=csv",
  EVENTS_SHEET: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_Oy4G9QEpQ51U9d7O6epRRsfj1V7K5rnDRvFDOhaoSrVo_Dv7S2XBMjgRnOdfuDkQ7p0uV9DeQJPF/pub?gid=1826647806&single=true&output=csv",
  WEATHER_KEY: "efe9b5d99cfc6b3d5127565e16dec5bc", 
  DEFAULT_CITY: "Eagle Mountain,US",
  WEEK_ROTATION_START: "2025-01-05" 
};

/* utility to fetch published CSV of a sheet tab */
async function fetchCSV(sheetName){
  const base = `https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
  const r = await fetch(base);
  if(!r.ok) throw new Error("Failed to fetch sheet: " + sheetName);
  const txt = await r.text();
  return csvToArray(txt);
}

/* tiny CSV parser (assumes no tricky quoted newlines) */
function csvToArray(csv){
  const lines = csv.trim().split(/\r?\n/);
  const headers = lines.shift().split(',').map(h=>h.trim());
  return lines.map(line=>{
    // split respecting quotes
    const values = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
    return headers.reduce((obj, h, i)=>{
      let v = (values[i] || "").trim();
      if(v.startsWith('"') && v.endsWith('"')) v = v.slice(1,-1);
      obj[h] = v;
      return obj;
    },{});
  });
}

/* ========== UI renderers ========== */

function renderDate(){
  const now = new Date();
  const opts = {weekday:'long', month:'long', day:'numeric', year:'numeric'};
  document.getElementById('todayHuman').textContent = now.toLocaleDateString(undefined, opts);
}

/* Kindness Leaderboard */
function renderKindness(data){
  // data = array of {Name,Points}
  const container = document.getElementById('leaderboard');
  container.innerHTML = '';
  // sort desc points
  data.sort((a,b)=> (Number(b.Points)||0) - (Number(a.Points)||0) );
  // find max for bars
  const max = Math.max(...data.map(r=>Number(r.Points)||0), 10);
  for(const r of data){
    const kid = document.createElement('div');
    kid.className = 'kid';
    kid.innerHTML = `
      <div class="row"><div style="font-weight:700">${r.Name}</div><div class="muted">${r.Points||0} pts</div></div>
      <div class="bar"><span style="width:${(Math.min(100,(Number(r.Points)||0)/max*100))}%"></span></div>
    `;
    container.appendChild(kid);
  }
}

/* Events */
function renderEvents(events){
  // events = array of {Date,Title,Details,Time}
  const list = document.getElementById('eventsList');
  const ticker = document.getElementById('ticker');
  list.innerHTML = '';
  const upcoming = events
    .map(e=>({...e, dateObj: new Date(e.Date + (e.Time ? "T"+e.Time : "T00:00"))}))
    .filter(e=>!isNaN(e.dateObj))
    .sort((a,b)=>a.dateObj - b.dateObj);
  if(upcoming.length===0){
    list.innerHTML = '<div class="muted small">No upcoming events</div>';
    ticker.textContent = 'No upcoming events';
    return;
  }
  const slice = upcoming.slice(0,6);
  for(const e of slice){
    const ev = document.createElement('div'); ev.className='event';
    const dateLabel = e.dateObj.toLocaleDateString(undefined,{month:'short', day:'numeric'});
    ev.innerHTML = `<div><div style="font-weight:700">${e.Title}</div><div class="muted small">${e.Details||''}</div></div><div class="muted small">${dateLabel}${e.Time ? ' • '+e.Time : ''}</div>`;
    list.appendChild(ev);
  }
  // ticker text
  ticker.textContent = upcoming.slice(0,20).map(e=>`${e.Date}: ${e.Title}`).join('   •   ');
}

/* Chore rotation logic:
   - chores: array of chore strings (index 0..n-1)
   - kids: array of kid names (in order we want to assign)
   - rotation anchored to WEEK_ROTATION_START (a Sunday)
   - For a given week index W, we assign chores[i] -> kids[(i + W) % n]
   - We'll show the assignment table and a wheel visualization.
*/
function computeWeekIndex(anchorISO){
  const anchor = new Date(anchorISO + 'T00:00:00');
  // find difference in calendar weeks (Sunday start)
  const now = new Date();
  // Normalize both to the most recent Sunday at 00:00
  function sundayStart(d){
    const copy = new Date(d.getFullYear(), d.getMonth(), d.getDate());
    const day = copy.getDay(); // 0 = Sunday
    copy.setDate(copy.getDate() - day);
    return copy;
  }
  const a = sundayStart(anchor);
  const b = sundayStart(now);
  const diffMs = b - a;
  const weeks = Math.floor(diffMs / (7 * 24 * 3600 * 1000));
  return Math.max(0, weeks);
}

function renderAssignments(chores, kids){
  // chores: [{Chore: "..."}], kids: array of names
  const choresArr = chores.map(c => c.Chore);
  const kidsArr = kids.map(k => k.Name);
  const n = choresArr.length;
  const m = kidsArr.length;
  const weekIndex = computeWeekIndex(CONFIG.WEEK_ROTATION_START);
  const table = document.getElementById('assignTable');
  const meta = document.getElementById('choreMeta');
  meta.textContent = `Week #${weekIndex} (rotation anchor: ${CONFIG.WEEK_ROTATION_START})`;
  // assignment: chores[i] -> kid at (i + weekIndex) % m
  const assignments = choresArr.map((ch, i) => {
    const kid = kidsArr[(i + weekIndex) % m];
    return {chore: ch, kid};
  });
  // render table
  table.innerHTML = assignments.map(a=>`<div style="padding:6px 0"><strong>${a.kid}</strong><div class="muted small">${a.chore}</div></div>`).join('');
  // render wheel
  renderWheel(assignments, kidsArr, weekIndex);
}

function renderWheel(assignments, kids, weekIndex){
  // create visual segments and animate spin to highlight the "current" kid for the top (we'll choose one 'selected' kid to center)
  // For fun, pick the kid assigned to chores[0] as center or compute a weekly "winner".
  const wheel = document.getElementById('wheelSvg');
  wheel.innerHTML = '';
  const n = assignments.length;
  // determine target highlight index: we'll highlight the kid assigned to the first chore (index 0)
  const targetKid = assignments[0].kid;
  // Build segments (we create one segment per assignment)
  for(let i=0;i<n;i++){
    const seg = document.createElement('div');
    seg.className='segment';
    const angle = (360 / n) * i;
    seg.style.transform = `rotate(${angle}deg)`;
    // slight color variation
    seg.style.background = `conic-gradient(rgba(255,255,255,0.03) 0 50%, transparent 50% 100%)`;
    seg.innerHTML = `<div style="transform:rotate(-${angle}deg); text-align:center; width:50%; margin-left:50%"><div style="font-weight:700">${assignments[i].kid}</div><div class="muted small">${assignments[i].chore}</div></div>`;
    wheel.appendChild(seg);
  }
  // center label show the name of the kid with chores[0] as current focal
  document.getElementById('centerLabel').textContent = `${assignments[0].kid}`;
  // animate an orientation rotation so that the targetKid segment rotates to top when page loads
  // find segment index where kid equals targetKid (first occurrence)
  const targetIndex = assignments.findIndex(a=>a.kid === targetKid);
  const rotateDeg = - (360 / n) * targetIndex; // rotate wheel so that that segment is at angle 0
  // apply transition
  wheel.style.transition = 'transform 2s cubic-bezier(.2,.9,.2,1)';
  wheel.style.transform = `rotate(${rotateDeg}deg)`;
  // add spin button to simulate spin
  document.getElementById('spinNow').onclick = async ()=>{
    // random extra spins then land on target
    const extras = Math.floor(Math.random()*3 + 3); // 3..5 extra rotations
    wheel.style.transition = 'transform 3s cubic-bezier(.3,.7,.2,1)';
    wheel.style.transform = `rotate(${360*extras + rotateDeg}deg)`;
    // after spin, bounce and set center label
    setTimeout(()=>{ document.getElementById('centerLabel').textContent = `${assignments[0].kid}`; }, 3200);
  };
}

/* Weather fetch (OpenWeatherMap current) */
async function fetchWeather(){
  if(!CONFIG.WEATHER_KEY){ document.getElementById('temp').textContent='--°'; document.getElementById('conditions').textContent='—'; return; }
  try{
    // simple by city name
    const q = encodeURIComponent(CONFIG.DEFAULT_CITY);
    const url = `https://api.openweathermap.org/data/2.5/weather?q=${q}&units=imperial&appid=${CONFIG.WEATHER_KEY}`;
    const r = await fetch(url); if(!r.ok) throw new Error('weather failed');
    const j = await r.json();
    const t = Math.round(j.main.temp);
    const cond = j.weather && j.weather[0] ? j.weather[0].description : '';
    document.getElementById('temp').textContent = `${t}°F`;
    document.getElementById('conditions').textContent = cond;
  }catch(e){
    console.warn(e);
    document.getElementById('temp').textContent='--°';
    document.getElementById('conditions').textContent='—';
  }
}

/* bootstrap everything */
async function init(){
  renderDate();
  try{
    // fetch sheets simultaneously
    const [kindness, chores, events] = await Promise.all([
      fetchCSV(CONFIG.KINDNESS_SHEET),
      fetchCSV(CONFIG.CHORES_SHEET),
      fetchCSV(CONFIG.EVENTS_SHEET)
    ]);
    renderKindness(kindness);
    renderEvents(events);
    renderAssignments(chores, kindness); // uses kindness names as kids list
  }catch(e){
    console.error(e);
    document.getElementById('leaderboard').innerHTML = '<div class="muted">Unable to load sheet data. Check SHEET_ID & publish settings.</div>';
    document.getElementById('assignTable').textContent = 'Error loading chore data';
    document.getElementById('eventsList').textContent = 'Error loading events';
  }
  await fetchWeather();
  // refresh every 15 minutes
  setInterval(init, 15*60*1000);
}

init();
</script>
</body>
</html>